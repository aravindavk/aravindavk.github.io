
<!DOCTYPE HTML>
<html lang="en">
    <head>
    <meta charset="utf-8">
    
    <title>Reserved space for Glusterd - Gluster FS - Aravinda Vishwanathapura</title>
    
    <meta name="generator" content="Nanoc 4.12.20">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/me_fav.png">
    <link rel="icon" type="image/png" sizes="300x300" href="/images/me_fav.png">
    <link rel="stylesheet" href="/bulma-0.9.4.min.css">
    <link rel="stylesheet" href="/pygment-emacs-highlight.css">
    <link rel="stylesheet" href="/stylesheet.css">
    <script defer src="/alpinejs-3.10.5.min.js"></script>
    
    <meta property="og:title" content="Reserved space for Glusterd - Gluster FS"/>
    <meta name="author" content=""/>
    <meta property="og:locale" content="en_US"/>
    <meta name="description" content="In this blog post, I will explain how we can reserve space for Gluster operations and not worry about the undefined behaviour of Glusterd when some other app in the system misbehaves."/>
    <meta property="og:description" content="In this blog post, I will explain how we can reserve space for Gluster operations and not worry about the undefined behaviour of Glusterd when some other app in the system misbehaves."/>
    <link rel="canonical" href="/blog/reserved-space-for-glusterd/"/>
    <meta property="og:url" content="/blog/reserved-space-for-glusterd/"/>
    <meta property="og:site_name" content="Aravinda Vishwanathapura"/>
    <meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2024-05-13"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://aravindavk.in/images/me.jpg"/>
    <meta name="twitter:image" content="https://aravindavk.in/images/me.jpg"/>
    
    <meta name="twitter:site" content="https://aravindavk.in"/>
    <meta name="twitter:title" content="Reserved space for Glusterd - Gluster FS"/>
    <meta name="twitter:description" content="In this blog post, I will explain how we can reserve space for Gluster operations and not worry about the undefined behaviour of Glusterd when some other app in the system misbehaves."/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer data-domain="aravindavk.in" src="https://plausible.io/js/plausible.js"></script>
</head>

    <body>
        <div id="main" class="container is-max-desktop px-4">
            <nav class="has-text-centered mb-6">
    <a class="link is-info is-inline-block px-2" href="/blog">Blog Posts</a>
    <a class="link is-info is-inline-block px-2" href="/talks-articles">Talks & Articles</a>
    <a class="link is-info is-inline-block px-2" href="/projects">Projects</a>
</nav>
<div class="has-text-centered py-6">
    <a href="/">
        <figure class="image is-64x64" style="margin: auto">
            <img class="is-rounded" src="/images/me.jpg">
        </figure>
        <p class="has-text-grey pb-6 is-size-6">ARAVINDA VISHWANATHAPURA</p>
    </a>
</div>

            <div class="has-text-centered">
                <h1 class="title">Reserved space for Glusterd - Gluster FS</h1>
                <div class="">May 13, 2024</div>
                <div class="">
                    <span class="icon-text">
                        <svg class="mr-1 icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                        <span><strong>1 minute</strong> read.</span>
                    </span>
                </div>
                <div>
                    
                    <span class="tag is-info is-light">gluster</span>
                    
                    <span class="tag is-info is-light">glusterfs</span>
                    
                </div>
            </div>
            <div class="content py-6">
                <div class="paragraph">
<p>Many Gluster FS users in the past reported that Glusterd (the Gluster FS  management service) misbehaves and corrupts the cluster state when the root partition fills up due to some other malfunctioned application or when log floods.</p>
</div>
<div class="paragraph">
<p>In this blog post, I will explain how we can reserve space for Gluster operations and not worry about the undefined behaviour of Glusterd when some other app in the system misbehaves.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the Glusterd service if running.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>systemctl stop glusterd</code></pre>
</div>
</div>
</li>
<li>
<p>Backup the <code>/var/lib/glusterd</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span><span class="nb">cp</span> <span class="nt">-r</span> /var/lib/glusterd /var/lib/glusterd.orig
<span class="gp">#</span><span class="w"> </span><span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/glusterd</code></pre>
</div>
</div>
</li>
<li>
<p>Create a pre-allocated file with required size. <code>1GiB</code> should be good enough for most of the Cluster sizes.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>fallocate <span class="nt">-l</span> 1G /data/glusterd.img</code></pre>
</div>
</div>
</li>
<li>
<p>Create the file system (xfs or ext4) and prepare the mount directory. Make the mount directory immutable to prevent Glusterd writing to this directory when <code>glusterd.img</code> is unmounted.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>mkfs.xfs /data/glusterd.img
<span class="gp">#</span><span class="w"> </span><span class="nb">mkdir</span> <span class="nt">-p</span> /var/lib/glusterd
<span class="gp">#</span><span class="w"> </span>chattr +i /var/lib/glusterd</code></pre>
</div>
</div>
</li>
<li>
<p>Now add the entry to <code>/etc/fstab</code> to mount the <code>glusterd.img</code> file on every node restart.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="config">/<span class="n">data</span>/<span class="n">gfs</span>/<span class="n">glusterd</span>.<span class="n">img</span>  /<span class="n">var</span>/<span class="n">lib</span>/<span class="n">glusterd</span>       <span class="n">xfs</span>     <span class="n">loop</span>    <span class="m">0</span>       <span class="m">0</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verify the <code>/etc/fstab</code> entry by running the <code>mount -a</code> command. Or manually mount the directory by running the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>mount <span class="nt">-t</span> xfs /data/glusterd.img /var/lib/glusterd</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the Glusterd data from the backup</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span><span class="nb">cp</span> <span class="nt">-r</span> /var/lib/glusterd.orig/<span class="k">*</span> /var/lib/glusterd/</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Glusterd service again</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>systemctl start glusterd</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="py-4"></div>
<div class="paragraph">
<p>Thats it! Now verify the mounted directory and Glusterd by running the following commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span><span class="nb">df</span> <span class="nt">-h</span> /var/lib/glusterd
<span class="go">Filesystem      Size  Used Avail Use% Mounted on
/dev/loop33     990M   30M  960M   3% /var/lib/glusterd
</span><span class="gp">#</span><span class="w">
</span><span class="gp">#</span><span class="w"> </span>gluster pool list
<span class="go">UUID                                    Hostname        State
1b58cfc0-15ed-40b8-be28-f7c341250777    localhost       Connected</span></code></pre>
</div>
</div>
            </div>
            <div class="has-text-centered mb-6 notification  is-light">
    
    <p class="has-text-grey is-uppercase is-size-5 pb-2">About Aravinda Vishwanathapura</p>
    
    Co-Founder & CTO at <a href="https://kadalu.tech">Kadalu Technologies</a>,
    Creator of <a href="https://aravindavk.in/sanka">Sanka</a>,
    Creator of <a href="https://aravindavk.in/chitra">Chitra</a>,
    <a href="https://gluster.org">GlusterFS</a> core team member,
    Maintainer of <a href="https://github.com/kadalu">Kadalu Storage</a>
    <div class="mt-6">
        Contact:
        <a href="http://in.linkedin.com/in/aravindavk">Linkedin</a> |
        <a href="https://twitter.com/aravindavk">Twitter</a> |
        <a href="http://facebook.com/aravindavk">Facebook</a> |
        <a href="https://github.com/aravindavk">Github</a> |
        mail&#64;&#97;&#114;&#97;&#118;&#105;&#110;&#100;&#97;&#118;&#107;&#46;&#105;&#110;
    </div>
</div>

        </div>
        <footer class="footer has-background-white-bis mt-6">
    <div class="content has-text-centered">
        <p>
            Copyright &copy; 2022 <strong>Aravinda Vishwanathapura</strong>.
        </p>
    </div>
</footer>

    </body>
</html>
