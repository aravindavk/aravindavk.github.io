
<!DOCTYPE HTML>
<html lang="en">
    <head>
    <meta charset="utf-8">
    
    <title>Effective GlusterFs monitoring using hooks - Aravinda Vishwanathapura</title>
    
    <meta name="generator" content="Nanoc 4.12.10">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/me_fav.png">
    <link rel="icon" type="image/png" sizes="300x300" href="/images/me_fav.png">
    <link rel="stylesheet" href="/bulma-0.9.4.min.css">
    <link rel="stylesheet" href="/pygment-emacs-highlight.css">
    <link rel="stylesheet" href="/stylesheet.css">
    <script defer src="/alpinejs-3.10.5.min.js"></script>
    
    <meta property="og:title" content="Effective GlusterFs monitoring using hooks"/>
    <meta name="author" content=""/>
    <meta property="og:locale" content="en_US"/>
    <meta name="description" content="Let us imagine we have a GlusterFs monitoring system which displays list of volumes and its state, to show the realtime status, monitoring app need to query the GlusterFs in regular interval to check volume status, new volumes etc. Assume if the polling interval is 5 seconds then monitoring app has to run "gluster volume info command" ~17000 times a day!"/>
    <meta property="og:description" content="Let us imagine we have a GlusterFs monitoring system which displays list of volumes and its state, to show the realtime status, monitoring app need to query the GlusterFs in regular interval to check volume status, new volumes etc. Assume if the polling interval is 5 seconds then monitoring app has to run "gluster volume info command" ~17000 times a day!"/>
    <link rel="canonical" href="/blog/effective-glusterfs-monitoring-using-hooks/"/>
    <meta property="og:url" content="/blog/effective-glusterfs-monitoring-using-hooks/"/>
    <meta property="og:site_name" content="Aravinda Vishwanathapura"/>
    <meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2013-11-28"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://aravindavk.in/images/me.jpg"/>
    <meta name="twitter:image" content="https://aravindavk.in/images/me.jpg"/>
    
    <meta name="twitter:site" content="https://aravindavk.in"/>
    <meta name="twitter:title" content="Effective GlusterFs monitoring using hooks"/>
    <meta name="twitter:description" content="Let us imagine we have a GlusterFs monitoring system which displays list of volumes and its state, to show the realtime status, monitoring app need to query the GlusterFs in regular interval to check volume status, new volumes etc. Assume if the polling interval is 5 seconds then monitoring app has to run "gluster volume info command" ~17000 times a day!"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer data-domain="aravindavk.in" src="https://plausible.io/js/plausible.js"></script>
</head>

    <body>
        <div id="main" class="container is-max-desktop px-4">
            <nav class="has-text-centered mb-6">
    <a class="link is-info is-inline-block px-2" href="/blog">Blog Posts</a>
    <a class="link is-info is-inline-block px-2" href="/talks-articles">Talks & Articles</a>
    <a class="link is-info is-inline-block px-2" href="/projects">Projects</a>
</nav>
<div class="has-text-centered py-6">
    <a href="/">
        <figure class="image is-64x64" style="margin: auto">
            <img class="is-rounded" src="/images/me.jpg">
        </figure>
        <p class="has-text-grey pb-6 is-size-6">ARAVINDA VISHWANATHAPURA</p>
    </a>
</div>

            <div class="has-text-centered">
                <h1 class="title">Effective GlusterFs monitoring using hooks</h1>
                <div class="">Nov 28, 2013</div>
                <div class=""><strong>3 minutes</strong> read</div>
                <div>
                    
                    <span class="tag is-info is-light">glusterfs</span>
                    
                    <span class="tag is-info is-light">glusterfsblog</span>
                    
                </div>
            </div>
            <div class="content py-6">
                <div class="paragraph">
<p>Let us imagine we have a GlusterFs monitoring system which displays list of volumes and its state, to show the realtime status, monitoring app need to query the GlusterFs in regular interval to check volume status, new volumes etc. Assume if the polling interval is 5 seconds then monitoring app has to run <code>gluster volume info</code> command ~17000 times a day!</p>
</div>
<div class="paragraph">
<p>How about maintaining a state file in each node? which gets updated after every new GlusterFs event(create, delete, start, stop etc).</p>
</div>
<div class="paragraph">
<p>In this blog post I am trying to explain the possibility of creating state file and using it.</p>
</div>
<div class="paragraph">
<p>As of today GlusterFs provides following hooks, which we can use to update our state file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">    create
    delete
    start
    stop
    add-brick
    remove-brick
    set</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_use_hooks">How to use hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GlusterFs hooks present in <code>/var/lib/glusterd/hooks/1</code> directory. Following example shows sending message to all users using <code>wall</code> command when any new GlusterFs volume is created.</p>
</div>
<div class="paragraph">
<p>Create a shell script <code>/var/lib/glusterd/hooks/1/create/post/SNotify.bash</code> and make it executable. Whenever a volume is created GlusterFs executes all the executable scripts present in respective hook directory(Glusterfs executes only the scripts which filename starting with 'S')</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nv">VOL</span><span class="o">=</span>
<span class="nv">ARGS</span><span class="o">=</span><span class="si">$(</span>getopt <span class="nt">-l</span> <span class="s2">"volname:"</span>  <span class="nt">-name</span> <span class="s2">""</span> <span class="nv">$@</span><span class="si">)</span>
<span class="nb">eval set</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$ARGS</span><span class="s2">"</span>
<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
    case</span> <span class="nv">$1</span> <span class="k">in</span>
        <span class="nt">--volname</span><span class="p">)</span>
            <span class="nb">shift
            </span><span class="nv">VOL</span><span class="o">=</span><span class="nv">$1</span>
            <span class="p">;;</span>
        <span class="k">*</span><span class="p">)</span>
            <span class="nb">shift
            break</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="nb">shift
</span><span class="k">done

</span>wall <span class="s2">"Gluster Volume Created: </span><span class="nv">$VOL</span><span class="s2">"</span><span class="p">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_experimental_project_glusterweb">Experimental project - GlusterWeb</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This experimental project maintains a sqlite database <code>/var/lib/glusterd/nodestate/glusternodestate.db</code> which gets updated after any GlusterFs event. For example if a GlusterFs volume is created then it updates volumes table and also bricks table.</p>
</div>
<div class="paragraph">
<p>This project depends on <a href="https://github.com/aravindavk/glusterfs-tools">glusterfs-tools</a> so install both projects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">git clone https://github.com/aravindavk/glusterfs-tools.git
<span class="nb">cd </span>glusterfs-tools
<span class="nb">sudo </span>python setup.py <span class="nb">install

</span>git clone https://github.com/aravindavk/glusterfs-web.git
<span class="nb">cd </span>glusterfs-web
<span class="nb">sudo </span>python setup.py <span class="nb">install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By running <code>setup</code>, this tool will install all the hooks which are required for monitoring. (<code>cleanup</code> is for removing all the hooks)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>glusternodestate setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>All set! now run <code>glusterweb</code> to start webapp.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>glusterweb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Web application starts running in <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code> you can change the port using <code>--port</code> or <code>-p</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>glusterweb <span class="nt">-p</span> 9000</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/glusterweb-v0.1.png" alt="GlusterWeb">
</div>
<div class="title">Initial version of web interface.</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_future_plans">Future plans</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Authentication</strong>: Option to provide username and password or access key while running glusterweb, For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>glusterweb <span class="nt">--username</span> aravindavk <span class="nt">--password</span> somesecret
<span class="c"># or</span>
<span class="nb">sudo </span>glusterweb <span class="nt">--key</span> secretonlyiknow</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>More gluster hooks support:</strong> we need more GlusterFs hooks for better monitoring(refer Problems below)</p>
</div>
<div class="paragraph">
<p><strong>More GlusterFs features support:</strong> As a experiment UI only lists volumes, we need improved UI and support for different gluster features.</p>
</div>
<div class="paragraph">
<p><strong>Actions support:</strong> Support for volume creation, adding/removing bricks etc.</p>
</div>
<div class="paragraph">
<p><strong>REST api and SDK:</strong> Providing REST api for gluster operations.</p>
</div>
<div class="paragraph">
<p><strong>Many more:</strong> Not yet planned :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problems">Problems</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>State file consistency:</strong> If glusterd goes down in the node then the database will have wrong details about node&#8217;s state. One workaround is to reset the database if glusterd is down using a cron job, when glusterd comes up, database will not gets updated and the database will have previous updated details. To prevent this we need a glusterfs hook for <code>glusterd-start</code>.</p>
</div>
<div class="paragraph">
<p><strong>More hooks:</strong> As of today we don&#8217;t have hooks for volume down/up, brick down/up and other events. We need following hooks for effective monitoring glusterfs.(Add more if anything missing in the list)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">    glusterd-start
    peer probe
    peer detach
    volume-down
    volume-up
    brick-up
    brick-down</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let me know your thoughts! Thanks.</p>
</div>
</div>
</div>
            </div>
            <div class="has-text-centered mb-6 notification  is-light">
    
    <p class="has-text-grey is-uppercase is-size-5 pb-2">About Aravinda Vishwanathapura</p>
    
    Co-Founder & CTO at <a href="https://kadalu.tech">Kadalu Technologies</a>,
    Creator of <a href="https://aravindavk.in/sanka">Sanka</a>,
    Creator of <a href="https://aravindavk.in/chitra">Chitra</a>,
    <a href="https://gluster.org">GlusterFS</a> core team member,
    Maintainer of <a href="https://github.com/kadalu">Kadalu Storage</a>
    <div class="mt-6">
        Contact:
        <a href="http://in.linkedin.com/in/aravindavk">Linkedin</a> |
        <a href="https://twitter.com/aravindavk">Twitter</a> |
        <a href="http://facebook.com/aravindavk">Facebook</a> |
        <a href="https://github.com/aravindavk">Github</a> |
        mail&#64;&#97;&#114;&#97;&#118;&#105;&#110;&#100;&#97;&#118;&#107;&#46;&#105;&#110;
    </div>
</div>

        </div>
        <footer class="footer has-background-white-bis mt-6">
    <div class="content has-text-centered">
        <p>
            Copyright &copy; 2022 <strong>Aravinda Vishwanathapura</strong>.
        </p>
    </div>
</footer>

    </body>
</html>
