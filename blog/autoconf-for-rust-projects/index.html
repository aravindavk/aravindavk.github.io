
<!DOCTYPE HTML>
<html lang="en">
    <head>
    <meta charset="utf-8">
    
    <title>Autoconf for Rust Projects - Aravinda Vishwanathapura</title>
    
    <meta name="generator" content="Nanoc 4.12.10">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/me_fav.png">
    <link rel="icon" type="image/png" sizes="300x300" href="/images/me_fav.png">
    <link rel="stylesheet" href="/bulma-0.9.4.min.css">
    <link rel="stylesheet" href="/pygment-emacs-highlight.css">
    <link rel="stylesheet" href="/stylesheet.css">
    <script defer src="/alpinejs-3.10.5.min.js"></script>
    
    <meta property="og:title" content="Autoconf for Rust Projects"/>
    <meta name="author" content=""/>
    <meta property="og:locale" content="en_US"/>
    <meta name="description" content="In this blog we will discuss about using Autoconf for Rust projects along with Cargo."/>
    <meta property="og:description" content="In this blog we will discuss about using Autoconf for Rust projects along with Cargo."/>
    <link rel="canonical" href="/blog/autoconf-for-rust-projects/"/>
    <meta property="og:url" content="/blog/autoconf-for-rust-projects/"/>
    <meta property="og:site_name" content="Aravinda Vishwanathapura"/>
    <meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2016-05-10"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://aravindavk.in/images/me.jpg"/>
    <meta name="twitter:image" content="https://aravindavk.in/images/me.jpg"/>
    
    <meta name="twitter:site" content="https://aravindavk.in"/>
    <meta name="twitter:title" content="Autoconf for Rust Projects"/>
    <meta name="twitter:description" content="In this blog we will discuss about using Autoconf for Rust projects along with Cargo."/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer data-domain="aravindavk.in" src="https://plausible.io/js/plausible.js"></script>
</head>

    <body>
        <div id="main" class="container is-max-desktop px-4">
            <nav class="has-text-centered mb-6">
    <a class="link is-info is-inline-block px-2" href="/blog">Blog Posts</a>
    <a class="link is-info is-inline-block px-2" href="/talks-articles">Talks & Articles</a>
    <a class="link is-info is-inline-block px-2" href="/projects">Projects</a>
</nav>
<div class="has-text-centered py-6">
    <a href="/">
        <figure class="image is-64x64" style="margin: auto">
            <img class="is-rounded" src="/images/me.jpg">
        </figure>
        <p class="has-text-grey pb-6 is-size-6">ARAVINDA VISHWANATHAPURA</p>
    </a>
</div>

            <div class="has-text-centered">
                <h1 class="title">Autoconf for Rust Projects</h1>
                <div class="">May 10, 2016</div>
                <div class=""><strong>4 minutes</strong> read</div>
                <div>
                    
                    <span class="tag is-info is-light">rust</span>
                    
                    <span class="tag is-info is-light"> autoconf</span>
                    
                </div>
            </div>
            <div class="content py-6">
                <div class="paragraph">
<p>Cargo is an awesome tool for managing <a href="http://rust-lang.org">Rust</a>
projects, it takes care of all the Rust dependencies. But to package
and distribute the generated files specific to target distribution is
very difficult. For example, if the generated binary to be used by
sudo user then we need to copy that to <code>/usr/sbin</code> directory instead
of <code>/usr/bin</code> (sbin path may change for example <code>/usr/local/sbin</code> ).</p>
</div>
<div class="paragraph">
<p>In this blog we will discuss about using Autoconf for Rust projects
along with Cargo.</p>
</div>
<div class="sect1">
<h2 id="_example_simple_web_server_and_a_systemd_service_file">Example: Simple Web server and a systemd service file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new project called <code>myservice</code> using,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">cargo new myservice <span class="nt">--bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update <code>Cargo.toml</code> with required Rust dependencies and other details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[package]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"myservice"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">authors</span> <span class="p">=</span> <span class="s">["NAME &lt;EMAIL&gt;"]</span>

<span class="nn">[dependencies]</span>
<span class="py">iron</span> <span class="p">=</span> <span class="s">"*"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and add the following example code in <code>src/main.rs</code> (Copied from <a href="http://ironframework.io" class="bare">http://ironframework.io</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">extern</span> <span class="k">crate</span> <span class="n">iron</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">iron</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">iron</span><span class="p">::</span><span class="n">status</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Request</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">IronResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="nn">Response</span><span class="p">::</span><span class="nf">with</span><span class="p">((</span><span class="nn">status</span><span class="p">::</span><span class="nb">Ok</span><span class="p">,</span> <span class="s">"Hello World!"</span><span class="p">)))</span>
    <span class="p">}</span>

    <span class="nn">Iron</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span><span class="nf">.http</span><span class="p">(</span><span class="s">"localhost:3000"</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"On 3000"</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a systemd unit file with the following content, we need Path of
bin to add it to service file. We will take help of Autoconf to
dynamically generate systemd unit file. Create a systemd unit file as
<code>myserviced.service.in</code> (Note the @SBINDIR@ autoconf variable)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">MyService</span>
<span class="py">After</span><span class="p">=</span><span class="s">syslog.target network.target</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="s">simple</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="s">@SBINDIR@/myserviced</span>
<span class="py">ExecReload</span><span class="p">=</span><span class="s">/bin/kill -SIGUSR2 $MAINPID</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="s">multi-user.target</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we use <code>@sbindir@</code> then it will not expand completely, introduce
a new variable <code>SBINDIR</code> in <code>configure.ac</code> which will expand
completely with default path.</p>
</div>
<div class="paragraph">
<p>Now we will create <code>configure.ac</code> file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">AC_INIT<span class="o">([</span>myservice], m4_esyscmd<span class="o">([</span><span class="nb">grep </span>version Cargo.toml | <span class="nb">awk</span> <span class="s1">'{print $3}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'"'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">])</span>, <span class="o">[</span>YOUR_EMAIL]<span class="o">)</span>

<span class="nv">VERSION</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep </span>version Cargo.toml | <span class="nb">awk</span> <span class="s1">'{print $3}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'"'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="si">)</span>

<span class="c"># Default value for sbindir</span>
<span class="nv">prefix_temp</span><span class="o">=</span><span class="nv">$prefix</span>
<span class="nv">exec_prefix_temp</span><span class="o">=</span><span class="nv">$exec_prefix</span>

<span class="nb">test</span> <span class="s2">"</span><span class="k">${</span><span class="nv">prefix</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"NONE"</span> <span class="o">&amp;&amp;</span> <span class="nv">prefix</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">ac_default_prefix</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">test</span> <span class="s2">"</span><span class="k">${</span><span class="nv">exec_prefix</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"NONE"</span> <span class="o">&amp;&amp;</span> <span class="nv">exec_prefix</span><span class="o">=</span><span class="s1">'${prefix}'</span>

<span class="c"># Initial Value is $exec_prefix/sbin</span>
<span class="nv">sbintemp</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">sbindir</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># Expands to $prefix/sbin</span>
<span class="nb">eval </span><span class="nv">sbintemp</span><span class="o">=</span><span class="se">\"</span><span class="k">${</span><span class="nv">sbintemp</span><span class="k">}</span><span class="se">\"</span>
<span class="c"># Expands to /usr/local/sbin or /usr/sbin if --prefix is passed</span>
<span class="nb">eval </span><span class="nv">sbintemp</span><span class="o">=</span><span class="se">\"</span><span class="k">${</span><span class="nv">sbintemp</span><span class="k">}</span><span class="se">\"</span>
<span class="nv">SBINDIR</span><span class="o">=</span><span class="k">${</span><span class="nv">sbintemp</span><span class="k">}</span>

AC_SUBST<span class="o">(</span>SBINDIR<span class="o">)</span>
AC_SUBST<span class="o">(</span>VERSION<span class="o">)</span>

AC_CONFIG_FILES<span class="o">([</span>Makefile
                 myserviced.service
                 myservice.spec]<span class="o">)</span>

AC_OUTPUT</code></pre>
</div>
</div>
<div class="paragraph">
<p>and <code>Makefile.in</code> file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">CWD :<span class="o">=</span> <span class="si">$(</span>shell <span class="nb">pwd</span><span class="si">)</span>
TARDIR :<span class="o">=</span> myservice-@VERSION@
RPMBUILD :<span class="o">=</span> <span class="si">$(</span>HOME<span class="si">)</span>/rpmbuild

devbuild:
    cargo build

build:
    cargo build <span class="nt">--release</span>

dist:
    @rm <span class="nt">-fr</span> ./dist
    <span class="nb">mkdir</span> <span class="nt">-p</span> ./dist/<span class="si">$(</span>TARDIR<span class="si">)</span>
    rsync <span class="nt">-r</span> <span class="nt">--exclude</span> .git/ <span class="nt">--exclude</span> dist/ <span class="nt">--exclude</span> target/ <span class="si">$(</span>CWD<span class="si">)</span>/ ./dist/<span class="si">$(</span>TARDIR<span class="si">)</span>
    <span class="nb">cd</span> ./dist/<span class="p">;</span> <span class="nb">tar</span> <span class="nt">-zcf</span> <span class="si">$(</span>TARDIR<span class="si">)</span>.tar.gz <span class="si">$(</span>TARDIR<span class="si">)</span><span class="p">;</span>

<span class="nb">install</span>: build
    <span class="nb">install</span> <span class="nt">-d</span> <span class="si">$(</span>DESTDIR<span class="si">)</span>@SBINDIR@
    <span class="nb">install</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">DESTDIR</span><span class="k">}</span>/usr/lib/systemd/system/
    <span class="nb">install</span> <span class="nt">-m</span> 755 ./target/release/myservice <span class="k">${</span><span class="nv">DESTDIR</span><span class="k">}</span>@SBINDIR@/myserviced
    <span class="nb">install</span> <span class="nt">-m</span> 0644 ./myserviced.service <span class="k">${</span><span class="nv">DESTDIR</span><span class="k">}</span>/usr/lib/systemd/system/myserviced.service

rpm: dist
    <span class="nb">rm</span> <span class="nt">-rf</span> <span class="si">$(</span>RPMBUILD<span class="si">)</span>/SOURCES/myservice<span class="k">*</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> <span class="si">$(</span>RPMBUILD<span class="si">)</span>/BUILD/myservice<span class="k">*</span>
    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="si">$(</span>RPMBUILD<span class="si">)</span>/SOURCES
    <span class="nb">cp</span> ./dist/myservice-@VERSION@.tar.gz <span class="si">$(</span>RPMBUILD<span class="si">)</span>/SOURCES<span class="p">;</span> <span class="se">\</span>
    rpmbuild <span class="nt">-ba</span> myservice.spec</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now project will looks like,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">$myservice/
    - Cargo.toml
	- src/
	    - main.rs
	- Makefile.in
	- configure.ac
    - myservice.service.in</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>autoconf</code> to generate <code>configure</code> file from <code>configure.ac</code>
file. Then run <code>./configure</code>, it will generate following files</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">Makefile.in =&gt; Makefile
myserviced.service.in =&gt; myserviced.service
myservice.spec.in =&gt; myservice.spec</code></pre>
</div>
</div>
<div class="paragraph">
<p>Steps to install <code>myservice</code> (Source installation),</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">autoconf
./configure
<span class="nb">sudo </span>make <span class="nb">install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>make install will run cargo build --release, and copies generated
binary to /usr/local/sbin and systemd service file to
/usr/lib/systemd/system</p>
</div>
<div class="paragraph">
<p>Binary can be installed to /usr/sbin by passing <code>--prefix=/usr</code> or
<code>--sbindir=/usr/sbin</code> to configure(For example,
<code>./configure --prefix=/usr</code> )</p>
</div>
<div class="paragraph">
<p><code>myservice</code> can now be enabled using,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>systemctl <span class="nb">enable </span>myserviced
<span class="nb">sudo </span>systemctl start myserviced</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bonus_generate_rpm_for_your_package">Bonus: Generate RPM for your package</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sample RPM spec file is available in the <a href="https://github.com/aravinda/rust_autoconf/myservice.spec.in">repo</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">autoconf
./configure
make rpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generated RPM will be available in <code>$HOME/rpmbuild/RPMS/x86_64/</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">rpm <span class="nt">-qlp</span> <span class="nv">$HOME</span>/rpmbuild/RPMS/x86_64/myservice-0.1.0-1.fc23.x86_64.rpm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">/usr/lib/systemd/system/myserviced.service
/usr/sbin/myserviced</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rust_cargo_and_autoconf_version">Rust, Cargo and Autoconf Version</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">rustc 1.8.0 (db2939409 2016-04-11)
cargo 0.9.0-nightly (8fc3fd8 2016-02-29)
autoconf (GNU Autoconf) 2.69</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reference project is available in github <a href="https://github.com/aravindavk/rust_autoconf" class="bare">https://github.com/aravindavk/rust_autoconf</a></p>
</div>
</div>
</div>
            </div>
            <div class="has-text-centered mb-6 notification  is-light">
    
    <p class="has-text-grey is-uppercase is-size-5 pb-2">About Aravinda Vishwanathapura</p>
    
    Co-Founder & CTO at <a href="https://kadalu.tech">Kadalu Technologies</a>,
    Creator of <a href="https://aravindavk.in/sanka">Sanka</a>,
    Creator of <a href="https://aravindavk.in/chitra">Chitra</a>,
    <a href="https://gluster.org">GlusterFS</a> core team member,
    Maintainer of <a href="https://github.com/kadalu">Kadalu Storage</a>
    <div class="mt-6">
        Contact:
        <a href="http://in.linkedin.com/in/aravindavk">Linkedin</a> |
        <a href="https://twitter.com/aravindavk">Twitter</a> |
        <a href="http://facebook.com/aravindavk">Facebook</a> |
        <a href="https://github.com/aravindavk">Github</a> |
        mail&#64;&#97;&#114;&#97;&#118;&#105;&#110;&#100;&#97;&#118;&#107;&#46;&#105;&#110;
    </div>
</div>

        </div>
        <footer class="footer has-background-white-bis mt-6">
    <div class="content has-text-centered">
        <p>
            Copyright &copy; 2022 <strong>Aravinda Vishwanathapura</strong>.
        </p>
    </div>
</footer>

    </body>
</html>
