
<!DOCTYPE HTML>
<html lang="en">
    <head>
    <meta charset="utf-8">
    
    <title>Qcow2 snapshots and Gluster Geo-replication - Aravinda Vishwanathapura</title>
    
    <meta name="generator" content="Nanoc 4.12.10">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/me_fav.png">
    <link rel="icon" type="image/png" sizes="300x300" href="/images/me_fav.png">
    <link rel="stylesheet" href="/bulma-0.9.4.min.css">
    <link rel="stylesheet" href="/pygment-emacs-highlight.css">
    <link rel="stylesheet" href="/stylesheet.css">
    <script defer src="/alpinejs-3.10.5.min.js"></script>
    
    <meta property="og:title" content="Qcow2 snapshots and Gluster Geo-replication"/>
    <meta name="author" content=""/>
    <meta property="og:locale" content="en_US"/>
    <meta name="description" content="Geo-replication is aware of Gluster Sharding feature and taking the advantage of syncing small sharded files instead of big qcow2 image files"/>
    <meta property="og:description" content="Geo-replication is aware of Gluster Sharding feature and taking the advantage of syncing small sharded files instead of big qcow2 image files"/>
    <link rel="canonical" href="/blog/qcow2-snapshots-and-gluster-georeplication/"/>
    <meta property="og:url" content="/blog/qcow2-snapshots-and-gluster-georeplication/"/>
    <meta property="og:site_name" content="Aravinda Vishwanathapura"/>
    <meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2016-03-14"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://aravindavk.in/images/me.jpg"/>
    <meta name="twitter:image" content="https://aravindavk.in/images/me.jpg"/>
    
    <meta name="twitter:site" content="https://aravindavk.in"/>
    <meta name="twitter:title" content="Qcow2 snapshots and Gluster Geo-replication"/>
    <meta name="twitter:description" content="Geo-replication is aware of Gluster Sharding feature and taking the advantage of syncing small sharded files instead of big qcow2 image files"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer data-domain="aravindavk.in" src="https://plausible.io/js/plausible.js"></script>
</head>

    <body>
        <div id="main" class="container is-max-desktop px-4">
            <nav class="has-text-centered mb-6">
    <a class="link is-info is-inline-block px-2" href="/blog">Blog Posts</a>
    <a class="link is-info is-inline-block px-2" href="/talks-articles">Talks & Articles</a>
    <a class="link is-info is-inline-block px-2" href="/projects">Projects</a>
</nav>
<div class="has-text-centered py-6">
    <a href="/">
        <figure class="image is-64x64" style="margin: auto">
            <img class="is-rounded" src="/images/me.jpg">
        </figure>
        <p class="has-text-grey pb-6 is-size-6">ARAVINDA VISHWANATHAPURA</p>
    </a>
</div>

            <div class="has-text-centered">
                <h1 class="title">Qcow2 snapshots and Gluster Geo-replication</h1>
                <div class="">Mar 14, 2016</div>
                <div class=""><strong>4 minutes</strong> read</div>
                <div>
                    
                    <span class="tag is-info is-light">gluster</span>
                    
                    <span class="tag is-info is-light"> glusterfsblog</span>
                    
                </div>
            </div>
            <div class="content py-6">
                <div class="paragraph">
<p>Gluster introduced sharding feature to store large files(which can
grow beyond a single brick) or to support running Virtual machines in
Gluster Volumes. Read more about sharding `here
&lt;<a href="http://blog.gluster.org/2015/12/introducing-shard-translator/&gt;`" class="bare">http://blog.gluster.org/2015/12/introducing-shard-translator/&gt;`</a><em> and
`here &lt;<a href="http://blog.gluster.org/2015/12/sharding-what-next-2/&gt;`" class="bare">http://blog.gluster.org/2015/12/sharding-what-next-2/&gt;`</a></em>.</p>
</div>
<div class="sect1">
<h2 id="_how_to_backup_vm_images">How to backup VM images?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Backing up VM images is not easy, rsync will consume more CPU to
calculate the checksum to sync only incremental changes.</p>
</div>
<div class="paragraph">
<p>Geo-replication is aware of Gluster Sharding feature and taking the
advantage of syncing small sharded files instead of big qcow2 image
files. But is the data consistent? In this blog we will understand how
to backup VM images to DR site consistently.</p>
</div>
<div class="paragraph">
<p>Read `here &lt;<a href="http://hrkscribbles.blogspot.in/2016/02/gluster-geo-replication-with-sharding.html&gt;`__" class="bare">http://hrkscribbles.blogspot.in/2016/02/gluster-geo-replication-with-sharding.html&gt;`__</a> to know more about Geo-replication support for sharding.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup">Setup:</h2>
<div class="sectionbody">
<div class="paragraph">
<p>VMs hosted in Gluster Volume(Master Volume) and Geo-replicated to
another Gluster Volume(Slave/Backup Volume). Sharding enabled in both
the Gluster Volumes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_internal_qcow2_snapshot">Using Internal Qcow2 snapshot:</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before starting Geo-replication every day, take qcow2 snapshot of all
the disks in Master Volume. Geo-rep will sync the data including the
created snapshots.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: bash</p>
<div class="literalblock">
<div class="content">
<pre>virsh snapshot-create-as --domain &lt;DOMAIN&gt; &lt;SNAP_NAME&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: bash</p>
<div class="literalblock">
<div class="content">
<pre>virsh snapshot-create-as --domain fedora22 sn1</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>But while taking internal snapshot, guest is <strong>paused</strong> :(</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: text</p>
<div class="literalblock">
<div class="content">
<pre># virsh list
 Id    Name                           State
----------------------------------------------------
 3     fedora22                       paused</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Note:</strong> If Guest has more RAM and actively modifying state, then more
time to take Snapshot.</p>
</div>
<div class="paragraph">
<p>Run Geo-replication using the scheduler script, which will
Set the checkpoint and automatically stops Geo-replication once
checkpoint is reached.(This utility will be available with
<code>glusterfs-3.7.9</code> release.)</p>
</div>
<div class="paragraph">
<p>Run <code>/usr/share/glusterfs/scripts/schedule_georep.py --help</code> for more
details about the script.(<code>/usr/local/share/</code> in case of source install)</p>
</div>
<div class="paragraph">
<p>Psudeo code:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: text</p>
<div class="literalblock">
<div class="content">
<pre>pool_dir=&lt;PATH_OF_MASTER_VOL_MOUNT&gt;
images=$(ls ${pool_dir})
For each images, take qcow2 snapshot
Run schedule_georep script</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once the scheduler script completes, check the <code>qemu-img info</code> in Slave
and confirm that Geo-rep synced everything from master Volume
including Snapshots created.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: bash</p>
<div class="literalblock">
<div class="content">
<pre>qemu-img info /mnt/gv2/f22.qcow2</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Example Output:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: text</p>
<div class="literalblock">
<div class="content">
<pre>image: /mnt/gv2/f22.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 2.8G
cluster_size: 65536
Snapshot list:
ID        TAG                 VM SIZE                DATE       VM CLOCK
2         sn2                    693M 2016-02-23 18:40:10   01:37:34.881
3         sn3                    693M 2016-02-23 18:47:06   01:44:15.950
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_external_qcow2_snapshot">Using External Qcow2 snapshot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once we take external snapshot, qcow2 image will become read only base
image and snapshot file will become overlay(Read more about backing
chain and overlay `here &lt;<a href="https://kashyapc.fedorapeople.org/virt/lc-2012/snapshots-handout.html&gt;`__" class="bare">https://kashyapc.fedorapeople.org/virt/lc-2012/snapshots-handout.html&gt;`__</a>).</p>
</div>
<div class="paragraph">
<p>New changes will be recorded in the overlay instead of base image,
Since base image is frozen Geo-rep will sync the consistent image to
Slave. Start Geo-replication and wait for scheduler script to end.</p>
</div>
<div class="paragraph">
<p>When multiple external snapshots taken, it is very difficult to
maintain the backing chain and reverting to a snapshot is not easy
when external snapshot is used. Once Geo-rep Scheduler script is
complete, blockcommit the image in Master side to prevent growing
backing chain.</p>
</div>
<div class="paragraph">
<p>Delete the external snapshot once the blockcommit returns success.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: bash</p>
<div class="literalblock">
<div class="content">
<pre>pool_dir=&lt;PATH_OF_MASTER_VOL_MOUNT&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Take External snapshot
virsh snapshot-create-as --domain &lt;DOMAIN&gt; &lt;SNAPNAME&gt;  \
    --diskspec vda,file=${pool_dir}/snaps/&lt;SNAPNAME&gt;.qcow2 \
    --disk-only --atomic --no-metadata</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Run Geo-replication
/usr/share/glusterfs/scripts/schedule_georep.py \
    &lt;MASTERVOL&gt; &lt;SLAVE&gt; &lt;SLAVEVOL&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Blockcommit
virsh blockcommit &lt;DOMAIN&gt; vda --active --verbose --pivot</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Remove the external Snapshot file
rm ${pool_dir}/snaps/&lt;SNAPNAME&gt;.qcow2</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>With this method, Slave will always have consitent base image.</p>
</div>
<div class="paragraph">
<p>Ref: <a href="http://wiki.libvirt.org/page/Live-disk-backup-with-active-blockcommit" class="bare">http://wiki.libvirt.org/page/Live-disk-backup-with-active-blockcommit</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We should use qcow2 external snapshot if Live backup is
required. External snapshot file will be deleted once blockcommit is
done in Master side.</p>
</div>
</div>
</div>
            </div>
        </div>
        <footer class="footer has-background-white-bis mt-6">
    <div class="content has-text-centered">
        <p>
            Copyright &copy; 2022 <strong>Aravinda Vishwanathapura</strong>.
        </p>
    </div>
</footer>

    </body>
</html>
