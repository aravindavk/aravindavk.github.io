
<!DOCTYPE HTML>
<html lang="en">
    <head>
    <meta charset="utf-8">
    
    <title>Monitoring Amber apps with Prometheus - Aravinda Vishwanathapura</title>
    
    <meta name="generator" content="Nanoc 4.12.10">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/me_fav.png">
    <link rel="icon" type="image/png" sizes="300x300" href="/images/me_fav.png">
    <link rel="stylesheet" href="/bulma-0.9.4.min.css">
    <link rel="stylesheet" href="/pygment-emacs-highlight.css">
    <link rel="stylesheet" href="/stylesheet.css">
    <script defer src="/alpinejs-3.10.5.min.js"></script>
    
    <meta property="og:title" content="Monitoring Amber apps with Prometheus"/>
    <meta name="author" content=""/>
    <meta property="og:locale" content="en_US"/>
    <meta name="description" content="Crometheus is the Prometheus client library for the Crystal programming language. It provides an easy way to integrate with any other web frameworks or as a standalone Prometheus exporter to monitor an external application or tool."/>
    <meta property="og:description" content="Crometheus is the Prometheus client library for the Crystal programming language. It provides an easy way to integrate with any other web frameworks or as a standalone Prometheus exporter to monitor an external application or tool."/>
    <link rel="canonical" href="/blog/amber-prometheus/"/>
    <meta property="og:url" content="/blog/amber-prometheus/"/>
    <meta property="og:site_name" content="Aravinda Vishwanathapura"/>
    <meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2020-11-01"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://aravindavk.in/images/me.jpg"/>
    <meta name="twitter:image" content="https://aravindavk.in/images/me.jpg"/>
    
    <meta name="twitter:site" content="https://aravindavk.in"/>
    <meta name="twitter:title" content="Monitoring Amber apps with Prometheus"/>
    <meta name="twitter:description" content="Crometheus is the Prometheus client library for the Crystal programming language. It provides an easy way to integrate with any other web frameworks or as a standalone Prometheus exporter to monitor an external application or tool."/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer data-domain="aravindavk.in" src="https://plausible.io/js/plausible.js"></script>
</head>

    <body>
        <div id="main" class="container is-max-desktop px-4">
            <nav class="has-text-centered mb-6">
    <a class="link is-info is-inline-block px-2" href="/blog">Blog Posts</a>
    <a class="link is-info is-inline-block px-2" href="/talks-articles">Talks & Articles</a>
    <a class="link is-info is-inline-block px-2" href="/projects">Projects</a>
</nav>
<div class="has-text-centered py-6">
    <a href="/">
        <figure class="image is-64x64" style="margin: auto">
            <img class="is-rounded" src="/images/me.jpg">
        </figure>
        <p class="has-text-grey pb-6 is-size-6">ARAVINDA VISHWANATHAPURA</p>
    </a>
</div>

            <div class="has-text-centered">
                <h1 class="title">Monitoring Amber apps with Prometheus</h1>
                <div class="">Nov 1, 2020</div>
                <div class="">
                    <span class="icon-text">
                        <svg class="mr-1 icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                        <span><strong>6 minutes</strong> read.</span>
                    </span>
                </div>
                <div>
                    
                    <span class="tag is-info is-light">amber</span>
                    
                    <span class="tag is-info is-light"> crystal</span>
                    
                    <span class="tag is-info is-light"> prometheus</span>
                    
                </div>
            </div>
            <div class="content py-6">
                <div class="paragraph">
<p><a href="https://github.com/Darwinnn/crometheus">Crometheus</a> is a <a href="https://prometheus.io">Prometheus</a> client library for instrumenting programs written in the <a href="https://crystal-lang.org">Crystal programming</a> language. It provides an easy way to integrate with any other web frameworks or as a standalone Prometheus exporter to monitor an external application or tool.</p>
</div>
<div class="paragraph">
<p>In this blog, we will see how to integrate Crometheus with <a href="https://amberframework.org">Amber</a> applications.</p>
</div>
<div class="paragraph">
<p>Add Crometheus as a dependency in your shard.yml file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">  <span class="na">crometheus</span><span class="pi">:</span>
    <span class="na">github</span><span class="pi">:</span> <span class="s">darwinnn/crometheus</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">master</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And run <code>shards install</code> to install the dependencies. In Amber, the HTTP handler is called Plug. To integrate Crometheus, include it as a Plug as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="crystal"><span class="c1"># file: config/initializers/metrics.cr</span>
<span class="nb">require</span> <span class="s2">"crometheus"</span>

<span class="no">Crometheus</span><span class="p">.</span><span class="nf">default_registry</span><span class="p">.</span><span class="nf">path</span> <span class="o">=</span> <span class="s2">"/metrics"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="gh">diff --git a/config/routes.cr b/config/routes.cr
index c50f03c..db1a94a 100644
</span><span class="gd">--- a/config/routes.cr
</span><span class="gi">+++ b/config/routes.cr
</span><span class="p">@@ -1,3 +1,5 @@</span>
<span class="gi">+require "crometheus"
+
</span> Amber::Server.configure do
   pipeline :web do
     # Plug is the method to use connect a pipe (middleware)
<span class="p">@@ -10,6 +12,7 @@</span> Amber::Server.configure do
     plug Amber::Pipe::Session.new
     plug Amber::Pipe::Flash.new
     plug Amber::Pipe::CSRF.new
<span class="gi">+    plug Crometheus.default_registry.get_handler
</span>   end

   pipeline :api do</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crometheus traps the <code>/metrics</code> (or configured path), but Amber doesn&#8217;t know about this dynamic route and produces the following error when the <code>/metrics</code> page is opened.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">2020-10-23T15:17:27.301760Z   WARN - error: Error: 404
The request was not found. GET - /metrics (Amber::Exceptions::RouteNotFound)
from lib/amber/src/amber/controller/static.cr:7:7 in 'index'
  from config/routes.cr:45:5 in '-&gt;'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/primitives.cr:255:3 in 'call'
  from lib/amber/src/amber/router/context.cr:78:5 in 'process_request'
  from lib/amber/src/amber/pipes/controller.cr:8:9 in 'call'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/http/server/handler.cr:28:7 in 'call_next'
  from lib/amber/src/amber/pipes/static.cr:85:11 in 'call_next_with_file_path'
  from lib/amber/src/amber/pipes/static.cr:45:9 in 'call'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/http/server/handler.cr:28:7 in 'call_next'
  from lib/amber/src/amber/pipes/error.cr:11:9 in 'call'
  from lib/amber/src/amber/pipes/pipeline.cr:20:11 in 'call'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/http/server/request_processor.cr:50:11 in 'process'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/http/server.cr:513:5 in 'handle_client'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/http/server.cr:468:13 in '-&gt;'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/primitives.cr:255:3 in 'run'
  from ../../../../../../usr/local/Cellar/crystal/0.35.1_1/src/fiber.cr:92:34 in '-&gt;'

08:47:27 error (Warn) Error: 404</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid this, add a dummy route and a controller to make Amber happy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="gh">diff --git a/config/routes.cr b/config/routes.cr
index c50f03c..876009b 100644
</span><span class="gd">--- a/config/routes.cr
</span><span class="gi">+++ b/config/routes.cr
</span><span class="p">@@ -30,7 +33,8 @@</span> Amber::Server.configure do
   routes :web do

       get "/", HomeController, :index
<span class="gi">+      get "/metrics", ApplicationController, :metrics
+
</span>   end

   routes :api do</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the below function to the <code>application_controller.cr</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="gh">diff --git a/src/controllers/application_controller.cr b/src/controllers/application_controller.cr
index 3f7b7e6..3cd44e2 100644
</span><span class="gd">--- a/src/controllers/application_controller.cr
</span><span class="gi">+++ b/src/controllers/application_controller.cr
</span><span class="p">@@ -3,4 +3,7 @@</span> require "jasper_helpers"
 class ApplicationController &lt; Amber::Controller::Base
   include JasperHelpers
   LAYOUT = "application.ecr"
<span class="gi">+
+  def metrics
+  end
</span> end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now browse <a href="http://localhost:3000/metrics" class="bare">http://localhost:3000/metrics</a> to see the default metrics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"># HELP process Standard process statistics
# TYPE process gauge
process_gc_heap_bytes 786432.0
process_gc_free_bytes 86016.0
process_gc_total_bytes 681168.0
process_gc_unmapped_bytes 0.0
process_bytes_since_gc 681168.0
process_cpu_seconds_total 0.055226</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crometheus provides a few metrics by default and enables a few more metrics by adding one more Plug as below. HttpCollector shows metrics related to all HTTP routes of application. To skip tracking the <code>/metrics</code> route, add HttpCollector Plug after the Crometheus default handler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="gh">index c50f03c..fc57a4d 100644
</span><span class="gd">--- a/config/routes.cr
</span><span class="gi">+++ b/config/routes.cr
</span><span class="p">@@ -1,3 +1,5 @@</span>
<span class="gi">+require "crometheus"
+
</span> Amber::Server.configure do
   pipeline :web do
     # Plug is the method to use connect a pipe (middleware)
<span class="p">@@ -10,6 +12,8 @@</span> Amber::Server.configure do
     plug Amber::Pipe::Session.new
     plug Amber::Pipe::Flash.new
     plug Amber::Pipe::CSRF.new
<span class="gi">+    plug Crometheus::Middleware::HttpCollector.new
+    plug Crometheus.default_registry.get_handler
</span>   end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now visit <a href="http://localhost:3000/metrics" class="bare">http://localhost:3000/metrics</a> to see the additional metrics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"># HELP http_request_duration_seconds The HTTP response duration of the application.
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_count{method="GET", path="/metrics"} 12.0
http_request_duration_seconds_sum{method="GET", path="/metrics"} 0.002073
http_request_duration_seconds_bucket{le="0.005", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.01", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.025", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.05", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.1", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.25", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="0.5", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="1.0", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="2.5", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="5.0", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="10.0", method="GET", path="/metrics"} 12.0
http_request_duration_seconds_bucket{le="+Inf", method="GET", path="/metrics"} 12.0
# HELP http_request_exceptions_total The total number of exceptions raised by the application.
# TYPE http_request_exceptions_total counter
# HELP http_requests_total The total number of HTTP requests handled by the application.
# TYPE http_requests_total counter
http_requests_total{code="200", method="GET", path="/metrics"} 12.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer examples to add custom metrics specific to your applications. <a href="https://github.com/Darwinnn/crometheus/tree/master/examples">github/Darwinnn/crometheus/examples</a></p>
</div>
<div class="paragraph">
<p>In the <a href="https://aravindavk.in/blog/crystal-prometheus">next blog</a> post, we will see how to use Crometheus to monitor external applications/services/tools.</p>
</div>
<div class="sect1">
<h2 id="_references">References:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://prometheus.io">Prometheus</a></p>
</li>
<li>
<p><a href="https://amberframework.org">Amber Framework</a></p>
</li>
<li>
<p><a href="https://crystal-lang.org">Crystal Programming language</a></p>
</li>
<li>
<p><a href="https://github.com/Darwinnn/crometheus">Crometheus</a></p>
</li>
</ul>
</div>
</div>
</div>
            </div>
            <div class="has-text-centered mb-6 notification  is-light">
    
    <p class="has-text-grey is-uppercase is-size-5 pb-2">About Aravinda Vishwanathapura</p>
    
    Co-Founder & CTO at <a href="https://kadalu.tech">Kadalu Technologies</a>,
    Creator of <a href="https://aravindavk.in/sanka">Sanka</a>,
    Creator of <a href="https://aravindavk.in/chitra">Chitra</a>,
    <a href="https://gluster.org">GlusterFS</a> core team member,
    Maintainer of <a href="https://github.com/kadalu">Kadalu Storage</a>
    <div class="mt-6">
        Contact:
        <a href="http://in.linkedin.com/in/aravindavk">Linkedin</a> |
        <a href="https://twitter.com/aravindavk">Twitter</a> |
        <a href="http://facebook.com/aravindavk">Facebook</a> |
        <a href="https://github.com/aravindavk">Github</a> |
        mail&#64;&#97;&#114;&#97;&#118;&#105;&#110;&#100;&#97;&#118;&#107;&#46;&#105;&#110;
    </div>
</div>

        </div>
        <footer class="footer has-background-white-bis mt-6">
    <div class="content has-text-centered">
        <p>
            Copyright &copy; 2022 <strong>Aravinda Vishwanathapura</strong>.
        </p>
    </div>
</footer>

    </body>
</html>
